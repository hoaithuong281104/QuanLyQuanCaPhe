--Module 1: Thủ tục lưu thông tin nhập hàng
CREATE PROCEDURE Mod1_LuuThongTinNhapHang (
    @Ma_HD_Nhap CHAR(6),        
    @NgayNhap DATE,
    @Ma_NCC CHAR(6),
    @Ma_NhanVien CHAR(6),
    @Ma_HD_No CHAR(6) = NULL
)
AS
BEGIN
    IF EXISTS (SELECT 1 FROM Nhap WHERE Ma_HD_Nhap = @Ma_HD_Nhap)
    BEGIN
        Print(N'Mã hóa đơn nhập đã tồn tại. Không thể thêm.')
        RETURN
    END

    INSERT INTO Nhap (Ma_HD_Nhap, NgayNhap, Ma_HD_No, Ma_NCC, Ma_NhanVien)
    VALUES (@Ma_HD_Nhap, @NgayNhap, @Ma_HD_No, @Ma_NCC, @Ma_NhanVien)
    
    PRINT N'Thông tin nhập hàng đã được lưu thành công.';
END

---------------Test:
EXEC Mod1_LuuThongTinNhapHang 
    @Ma_HD_Nhap = 'NH0002',        -- Mã hóa đơn nhập mới
    @NgayNhap = '2024-10-20',      -- Ngày nhập
    @Ma_NCC = 'CC0002',            -- Mã nhà cung cấp
    @Ma_NhanVien = 'NV0002',       -- Mã nhân viên thực hiện
    @Ma_HD_No = 'NO0002';          -- Mã hóa đơn nợ (nếu có, có thể NULL)

--Module 2: Hàm tính tổng tiền cho một hoá đơn nhập
CREATE FUNCTION Mod2_TinhTongTienHDNhap(@Ma_HD_Nhap CHAR(6))
RETURNS NUMERIC(15, 2)
AS
BEGIN
    DECLARE @TongTien NUMERIC(15, 2)

    SELECT @TongTien = SUM(NCT.SoLuong * Hang.DonGia)
    FROM Nhap_CT NCT
    JOIN Hang ON NCT.Ma_H = Hang.Ma_H
    WHERE NCT.Ma_HD_Nhap = @Ma_HD_Nhap
    RETURN @TongTien
END
-------Test:
SELECT dbo.Mod2_TinhTongTienHDNhap('NH0001') AS TongTien;

--Module 3: Thủ tục tính tổng tiền nhập khoảng thời gian (startDate-endDate) (Chi phí)
CREATE PROCEDURE Mod3_TinhTongChiPhiNhap
    @startDate DATE,
    @endDate DATE
AS
BEGIN

    SELECT SUM(Nhap_CT.SoLuong * Hang.DonGia) AS TongChiPhi
    FROM Nhap
    INNER JOIN Nhap_CT ON Nhap.Ma_HD_Nhap = Nhap_CT.Ma_HD_Nhap
	INNER JOIN Hang ON Nhap_CT.Ma_H = Hang.Ma_H
    WHERE Nhap.NgayNhap BETWEEN @startDate AND @endDate
END

-----------Test:
EXEC Mod3_TinhTongChiPhiNhap '2024-01-01', '2024-12-31'

--Module 4: Trigger cập nhật giá trị tổng tiền của hóa đơn Nhap sau khi thêm/ sửa/ xóa số lượng nhậpCT (print Tiền ban đầu, tiền thay đổi)
CREATE TRIGGER mod4_trigger_ThongBaoTongTienNhap
ON Nhap_CT
AFTER INSERT, UPDATE, DELETE
AS
BEGIN

    DECLARE @Ma_HD_Nhap char(6)
    DECLARE @TongTienCu numeric(15)
    DECLARE @TongTienMoi numeric(15)
    
    IF EXISTS (SELECT * FROM inserted)
        SELECT @Ma_HD_Nhap = Ma_HD_Nhap FROM inserted
    ELSE IF EXISTS (SELECT * FROM deleted)
        SELECT @Ma_HD_Nhap = Ma_HD_Nhap FROM deleted

    SELECT @TongTienCu = ISNULL(
        (--Tiền của các dòng không bị xóa/sửa, isnull để khi null trả về bằng 0
            SELECT SUM(Nhap_CT.SoLuong * Hang.DonGia)
            FROM Nhap_CT
            JOIN Hang ON Nhap_CT.Ma_H = Hang.Ma_H
            WHERE Nhap_CT.Ma_HD_Nhap = @Ma_HD_Nhap
        ), 0) +
        ISNULL(
        (  -- Cộng vào tiền của các dòng bị xóa/sửa (từ deleted)
            SELECT SUM(deleted.SoLuong * Hang.DonGia)
            FROM deleted
            JOIN Hang ON deleted.Ma_H = Hang.Ma_H
            WHERE deleted.Ma_HD_Nhap = @Ma_HD_Nhap
        ), 0) -
        ISNULL(
        (
            -- Trừ đi tiền của các dòng mới thêm/sửa (từ inserted)
            SELECT SUM(inserted.SoLuong * Hang.DonGia)
            FROM inserted
            JOIN Hang ON inserted.Ma_H = Hang.Ma_H
            WHERE inserted.Ma_HD_Nhap = @Ma_HD_Nhap
        ), 0)

    SELECT @TongTienMoi = ISNULL(SUM(Nhap_CT.SoLuong * Hang.DonGia), 0)
    FROM Nhap_CT
    JOIN Hang ON Nhap_CT.Ma_H = Hang.Ma_H
    WHERE Nhap_CT.Ma_HD_Nhap = @Ma_HD_Nhap

    PRINT N'Mã hóa đơn: ' + @Ma_HD_Nhap
    PRINT N'Tổng tiền cũ: ' + CAST(@TongTienCu AS nvarchar(20))
    PRINT N'Tổng tiền mới: ' + CAST(@TongTienMoi AS nvarchar(20))
    PRINT N'Thay đổi: ' + CAST((@TongTienMoi - @TongTienCu) AS nvarchar(20))
END
-------------Test:
INSERT INTO Nhap_CT(Ma_HD_Nhap, Ma_H, SoLuong)
VALUES ('NH0110', 'H00101', 5)
select * from Nhap_CT

DELETE FROM Nhap_CT
WHERE Ma_HD_Nhap = 'NH0110'

--Module 5: Thủ tục kiểm tra Mã HD và mã Hàng khi thêm 1 Nhap_CT mới. Nếu trùng thì báo lỗi, không thì thêm
CREATE PROCEDURE Mod5_procKiemTraThemNhap_CT
    @Ma_HD_Nhap CHAR(6),
    @Ma_H CHAR(6),
    @SoLuong INT,
	@Output nvarchar(50) OUTPUT
AS
BEGIN
    IF EXISTS (
        SELECT 1
        FROM Nhap_CT
        WHERE Ma_HD_Nhap = @Ma_HD_Nhap
        AND Ma_H = @Ma_H
    )
    BEGIN
		SET @Output = (N'Đã tồn tại bản ghi')
        RETURN;
    END
    ELSE
    BEGIN
        INSERT INTO Nhap_CT (Ma_HD_Nhap, Ma_H, SoLuong)
        VALUES (@Ma_HD_Nhap, @Ma_H, @SoLuong)
        SET @Output = N'Dữ liệu đã được thêm thành công.'
    END
END

declare @Output nvarchar(50)
Exec Mod5_procKiemTraThemNhap_CT 'NH0110','H00120', 7, @Output out
print @output

select * from Nhap
select * from Nhap_CT

--Module 6: Thủ tục hoặc Trigger xóa các bảng Nhap_CT khi xóa một bảng Nhap
CREATE TRIGGER Mod6_triggerXoaNhap
ON Nhap
FOR DELETE
AS
BEGIN
    DELETE FROM Nhap_CT
    WHERE Ma_HD_Nhap IN (SELECT Ma_HD_Nhap FROM DELETED)
END

INSERT INTO Nhap_CT(Ma_HD_Nhap, Ma_H, SoLuong)
VALUES ('NH0110', 'H00101', 6)
select * from Nhap_CT

DELETE FROM Nhap_CT
WHERE Ma_HD_Nhap = 'NH0110'

DELETE FROM Nhap_CT
WHERE Ma_HD_Nhap = 'NH0003'
  AND Ma_H = 'H00101'

  --Mod 7: Thủ tục lưu thông tin bán hàng
CREATE PROCEDURE Mod7_LuuThongTinBanHang
    @Ma_HD_BanHang CHAR(6),        
    @NgayThanhToan DATE,
	@PhuongThucThanhToan bit,
	@So_Ban int,
    @Ma_NhanVien CHAR(6)
AS
BEGIN
    IF EXISTS (SELECT 1 FROM BanHang WHERE Ma_HD_BanHang = @Ma_HD_BanHang)
    BEGIN
        Print N'Mã hóa đơn bán hàng đã tồn tại. Không thể thêm.'
        RETURN
    END

    INSERT INTO BanHang(Ma_HD_BanHang, NgayThanhToan, PhuongThucThanhToan, So_Ban, Ma_NhanVien)
    VALUES (@Ma_HD_BanHang, @NgayThanhToan, @PhuongThucThanhToan, @So_Ban, @Ma_NhanVien)    
    PRINT N'Thông tin bán hàng đã được lưu thành công.';
END
-----Test
Exec Mod7_LuuThongTinBanHang 'BH1114', '2024-01-01', 0, 4,'NV0990'
select * from BanHang

--Mod 8: Hàm tính tổng tiền cho một hđ bán
CREATE FUNCTION Mod8_TinhTongTienHoaDonBan (@Ma_HD_BanHang CHAR(6))
RETURNS NUMERIC(15, 2)
AS
BEGIN
    DECLARE @TongTien NUMERIC(15, 2)

    SELECT @TongTien = SUM(BanHang_CT.SoLuong * MonNuoc.DonGia)
    FROM BanHang_CT
    JOIN MonNuoc ON BanHang_CT.Ma_Mon = MonNuoc.Ma_Mon
    WHERE BanHang_CT.Ma_HD_BanHang = @Ma_HD_BanHang

    RETURN @TongTien
END
--------------Test:
SELECT dbo.Mod8_TinhTongTienHoaDonBan('BH0001') AS TongTien

--Mod 9: Thủ tục tính tổng doanh thu khoảng thời gian (startDate-endDate) (doanh thu)
CREATE PROCEDURE Mod9_TinhTongDoanhThu
    @startDate DATE,
    @endDate DATE
AS
BEGIN

    SELECT SUM(BanHang_CT.SoLuong * MonNuoc.DonGia) AS TongDoanhThu
    FROM BanHang 
    JOIN BanHang_CT ON BanHang.Ma_HD_BanHang = BanHang_CT.Ma_HD_BanHang
    JOIN MonNuoc ON BanHang_CT.Ma_Mon = MonNuoc.Ma_Mon
    WHERE BanHang.NgayThanhToan BETWEEN @startDate AND @endDate
END

------ test 
EXEC Mod9_TinhTongDoanhThu '2022-01-01', '2022-12-31'

--Mod 10: Trigger cập nhật giá trị ThanhTien của hóa đơn BanHang sau khi thêm/sửa/xóa số lượng BanHangCT  (print Tiền ban đầu, tiền thay đổi)
CREATE TRIGGER Mod10_triggerThanhTienBanHang
ON BanHang_CT
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    DECLARE @Ma_HD_BanHang CHAR(6);
    DECLARE @TongTienCu NUMERIC(15, 2);
    DECLARE @TongTienMoi NUMERIC(15, 2);

    -- Lấy mã hóa đơn từ bản ghi INSERTED hoặc DELETED
    IF EXISTS (SELECT * FROM inserted)
        SELECT TOP 1 @Ma_HD_BanHang = Ma_HD_BanHang FROM inserted
    ELSE IF EXISTS (SELECT * FROM deleted)
        SELECT TOP 1 @Ma_HD_BanHang = Ma_HD_BanHang FROM deleted

    -- Tính tổng tiền cũ (trước khi thay đổi) từ các dòng không bị ảnh hưởng trong bảng BanHang_CT và các bản ghi trong deleted
    SELECT @TongTienCu = ISNULL(
        (SELECT SUM(BanHang_CT.SoLuong * MonNuoc.DonGia)
         FROM BanHang_CT
         JOIN MonNuoc ON BanHang_CT.Ma_Mon = MonNuoc.Ma_Mon
         WHERE BanHang_CT.Ma_HD_BanHang = @Ma_HD_BanHang), 0) + 
        ISNULL(
        (SELECT SUM(deleted.SoLuong * MonNuoc.DonGia)
         FROM deleted
         JOIN MonNuoc ON deleted.Ma_Mon = MonNuoc.Ma_Mon
         WHERE deleted.Ma_HD_BanHang = @Ma_HD_BanHang), 0) - 
        ISNULL(
        (SELECT SUM(inserted.SoLuong * MonNuoc.DonGia)
         FROM inserted
         JOIN MonNuoc ON inserted.Ma_Mon = MonNuoc.Ma_Mon
         WHERE inserted.Ma_HD_BanHang = @Ma_HD_BanHang), 0);

    -- Tính tổng tiền mới (sau khi thay đổi) từ bảng BanHang_CT hiện tại
    SELECT @TongTienMoi = ISNULL(
        (SELECT SUM(BanHang_CT.SoLuong * MonNuoc.DonGia)
         FROM BanHang_CT
         JOIN MonNuoc ON BanHang_CT.Ma_Mon = MonNuoc.Ma_Mon
         WHERE BanHang_CT.Ma_HD_BanHang = @Ma_HD_BanHang), 0)

    -- In ra tiền ban đầu và tiền đã thay đổi
    PRINT N'Mã hóa đơn: ' + @Ma_HD_BanHang;
    PRINT N'Tiền ban đầu: ' + CAST(@TongTienCu AS NVARCHAR(20));
    PRINT N'Tiền đã thay đổi: ' + CAST(@TongTienMoi AS NVARCHAR(20));
    PRINT N'Thay đổi: ' + CAST((@TongTienMoi - @TongTienCu) AS NVARCHAR(20));
END

--Mod11: Thủ tục kiểm tra Mã HD và mã Món khi thêm 1 BanHangCT mới. Nếu trùng thì báo lỗi, không thì thêm
CREATE PROCEDURE proc_KiemTraThemBanHang_CT
    @Ma_HD_Nhap CHAR(6),
    @Ma_M CHAR(6),
    @SoLuong INT,
    @Output nvarchar(50) OUTPUT
AS
BEGIN
    IF EXISTS (
        SELECT 1
        FROM BanHang_CT
        WHERE Ma_HD_Nhap = @Ma_HD_Nhap
        AND Ma_M = @Ma_M
    )
    BEGIN
        SET @Output = N'Đã tồn tại bản ghi';
    END
    ELSE
    BEGIN
        INSERT INTO BanHang_CT (Ma_HD_Nhap, Ma_M, SoLuong)
        VALUES (@Ma_HD_Nhap, @Ma_M, @SoLuong)
        SET @Output = N'Dữ liệu đã được thêm thành công.'
    END
END

--Mod 12: Thủ tục hoặc Trigger xóa các bảng BanHang_CT khi xóa một bảng BanHang
CREATE TRIGGER Mod12_triggerXoaBanHang_CT
ON BanHang
AFTER DELETE
AS
BEGIN
    DELETE FROM BanHang_CT
    WHERE Ma_HD_BanHang IN (SELECT Ma_HD_BanHang FROM DELETED)
END
--Mod 13: Thủ tục tính tổng tiền nợ của 1 nhà cung cấp or các nhà cung cấp
CREATE PROCEDURE Mod13_proc_ThongKeNo
    @Ma_NCC char(6) = NULL
As
BEGIN
    IF @Ma_NCC IS NOT NULL  -- Tính cho 1 NCC cụ thể
    BEGIN
        SELECT 
			NhaCungCap.Ma_NCC,
			NhaCungCap.Ten_NCC,
			COUNT(No.Ma_HD_No)as SoLuongNo,
			Sum(No.Tien_No) as TongNo
		From NhaCungCap
		Join No on NhaCungCap.Ma_NCC=No.Ma_NCC
		Where NhaCungCap.Ma_NCC=@Ma_NCC
		group by NhaCungCap.Ma_NCC, Ten_NCC
	End
	Else	--Tính nợ toàn bộ NCC
	Begin
		Select
			NhaCungCap.Ma_NCC,
			NhaCungCap.Ten_NCC,
			COUNT(No.Ma_HD_No) as SoLuongNo,
            SUM(No.Tien_No) as TongNo
		From NhaCungCap
		join No on NhaCungCap.Ma_NCC=No.Ma_NCC
		Group by NhaCungCap.Ma_NCC, Ten_NCC
		order by TongNo desc
		end
End

EXEC Mod13_proc_ThongKeNo
EXEC Mod13_proc_ThongKeNo 'CC0565'

--Mod 14: Thủ tục cập nhật tổng nợ khi thêm/sửa/xóa dữ liệu ở bảng No (Print: nợ ban đầu, nợ sau cập nhật)
create or alter trigger Capnhattongno
on No
after insert, update, delete
as
begin
	declare @TienNoMoi int,
			@TienNoCu int,
			@Tiengiaodich int,
			@Ma_HD_No CHAR(6)
	set @TienNoMoi = (select Tien_No from inserted)
	set @TienNoCu = (select Tien_No from deleted)
	--Nợ Thêm
	update no
	set @TienNoMoi = @TienNoCu + @Tiengiaodich
	where Ma_HD_No=@Ma_HD_No
	if @@ROWCOUNT=0
	begin
		print N'Chua Cap Nhat'
		rollback
	end
	if @@ROWCOUNT >= 1
	begin
		print N'No Da Cap Nhat'
	end
	--Trả nợ
	update no
	set @TienNoMoi = @TienNoCu - @Tiengiaodich
	where Ma_HD_No=@Ma_HD_No
	if @@ROWCOUNT=0
	begin
		print N'Chua Cap Nhat'
		rollback
	end
	if @@ROWCOUNT >= 1
	begin
		print N'No Da Cap Nhat'
	end
end

--Mod 15: Kiểm tra Món có số lượng bán nhiều nhất khoảng thời gian (startDate-endDate)
CREATE PROCEDURE Mod15_trigger_MonNuocBanChayNhat
    @startDate DATE,
    @endDate DATE
AS
BEGIN
    DECLARE @maxDoanhSo INT;
	SELECT @maxDoanhSo = MAX(DoanhSo)
    FROM 
    (
        SELECT SUM(BanHang_CT.SoLuong) AS DoanhSo
        FROM BanHang_CT
        JOIN BanHang ON BanHang_CT.Ma_HD_BanHang = BanHang.Ma_HD_BanHang
        WHERE BanHang.NgayThanhToan BETWEEN @startDate AND @endDate
        GROUP BY BanHang_CT.Ma_Mon
    ) AS DoanhSoTable

    IF @maxDoanhSo IS NULL
    BEGIN
        PRINT N'Không có món nước nào ở thời gian này!';
        RETURN
    END

    -- Lọc các món nước có doanh số bằng doanh số lớn nhất
    SELECT MonNuoc.Ten_Mon, SUM(BanHang_CT.SoLuong) AS DoanhSo
    FROM BanHang_CT
    JOIN BanHang ON BanHang_CT.Ma_HD_BanHang = BanHang.Ma_HD_BanHang
    JOIN MonNuoc ON BanHang_CT.Ma_Mon = MonNuoc.Ma_Mon
    WHERE BanHang.NgayThanhToan BETWEEN @startDate AND @endDate
    GROUP BY MonNuoc.Ten_Mon
    HAVING SUM(BanHang_CT.SoLuong) = @maxDoanhSo
END

---Test 15:
EXEC Mod15_trigger_MonNuocBanChayNhat '2023-03-01', '2023-03-31'

--Mod 16: Hàm cập nhật giá khi nhập giá và mã hàng
CREATE PROCEDURE Mod16_CapNhatGiaHang
    @Ma_H CHAR(6),
    @GiaMoi NUMERIC(15)
AS
BEGIN
    IF NOT EXISTS (SELECT 1 FROM Hang WHERE Ma_H = @Ma_H)
    BEGIN
        Print(N'Mã hàng không tồn tại.');
        RETURN;
    END
	ELSE
	Begin
		UPDATE Hang
		SET DonGia = @GiaMoi
		WHERE Ma_H = @Ma_H;
		PRINT N'Cập nhật giá thành công.'
	END
END
---------------Test
select * from Hang
EXEC Mod16_CapNhatGiaHang 'H00001', 20000;

--Mod 17: Hàm cập nhật giá khi nhập giá và mã món nước
CREATE PROCEDURE Mod17_CapNhatGiaMonNuoc
    @Ma_Mon CHAR(6),
    @GiaMoi NUMERIC(15)
AS
BEGIN
    IF NOT EXISTS (SELECT 1 FROM MonNuoc WHERE Ma_Mon = @Ma_Mon)
    BEGIN
        Print(N'Mã món nước không tồn tại.');
    END
	Else
	Begin
		UPDATE MonNuoc
		SET DonGia = @GiaMoi
		WHERE Ma_Mon = @Ma_Mon;
		Print(N'Đã cập nhật món')
	End
END
select * from MonNuoc

----------Test
EXEC Mod17_CapNhatGiaMonNuoc 'MN1101', 25000

--Mod 18: Thủ tục thêm hàng hóa mới
CREATE PROCEDURE Mod18_trigger_ThemHangHoa
    @Ma_H CHAR(6),           
    @Ten_H NVARCHAR(100),   
    @DonGia NUMERIC(15)     
AS
BEGIN
    -- Kiểm tra xem mã hàng đã tồn tại hay chưa bằng COUNT(*)
    IF (SELECT COUNT(*) FROM Hang WHERE Ma_H = @Ma_H) > 0
    BEGIN
        PRINT N'Đã tồn tại';
        RETURN; 
    END

    INSERT INTO Hang (Ma_H, Ten_H, DonGia)
    VALUES (@Ma_H, @Ten_H, @DonGia)
    PRINT N'Thêm thành công'
END
------Test
select * from Hang
EXEC Mod18_trigger_ThemHangHoa @Ma_H = 'H01001', @Ten_H = N'Nước Ngọt', @DonGia = 20000

--Mod 19: Thủ tục thêm món nước mới
CREATE PROCEDURE Mod19_ThemMonNuoc
    @Ma_Mon CHAR(6),          
    @Ten_Mon NVARCHAR(100),     
    @DonGia NUMERIC(15)         
AS
BEGIN
    -- Kiểm tra xem mã món đã tồn tại hay chưa bằng COUNT(*)
    IF (SELECT COUNT(*) FROM MonNuoc WHERE Ma_Mon = @Ma_Mon) > 0
    BEGIN
        PRINT N'Đã tồn tại'
        RETURN -- Dừng thực thi thủ tục
    END

    -- Thêm món nước mới vào bảng MonNuoc
    INSERT INTO MonNuoc (Ma_Mon, Ten_Mon, DonGia)
    VALUES (@Ma_Mon, @Ten_Mon, @DonGia)

    PRINT N'Thêm thành công.'
END

--Mod 20: Thủ tục tính lợi nhuận theo khoảng thời gian (startDate-endDate)
CREATE PROCEDURE Mod20_tinh_LoiNhuan
    @StartDate DATE,
    @EndDate DATE
AS
BEGIN
    DECLARE @doanhthu NUMERIC(15, 2);
    DECLARE @chiphi NUMERIC(15, 2);
    DECLARE @loinhuan NUMERIC(15, 2);

    -- Tính tổng doanh thu từ bảng BanHang
    SELECT @doanhthu = ISNULL(SUM(BanHang_CT.SoLuong * MonNuoc.DonGia), 0)
    FROM BanHang
    JOIN BanHang_CT ON BanHang.Ma_HD_BanHang = BanHang_CT.Ma_HD_BanHang
    JOIN MonNuoc ON BanHang_CT.Ma_Mon = MonNuoc.Ma_Mon
    WHERE BanHang.NgayThanhToan BETWEEN @StartDate AND @EndDate;

    -- Tính tổng chi phí từ bảng Nhap_CT
    SELECT @chiphi = ISNULL(SUM(Nhap_CT.SoLuong * Hang.DonGia), 0)
    FROM Nhap
    JOIN Nhap_CT ON Nhap.Ma_HD_Nhap = Nhap_CT.Ma_HD_Nhap
    JOIN Hang ON Nhap_CT.Ma_H = Hang.Ma_H
    WHERE Nhap.NgayNhap BETWEEN @StartDate AND @EndDate;

    -- Tính lợi nhuận
    SET @loinhuan = isnull(@doanhthu,0) - isnull(@chiphi,0)

    -- Trả kết quả
    SELECT 
        @doanhthu AS doanhthu,
        @chiphi AS chiphi,
        @loinhuan AS loinhuan
END

------test--------
EXEC Mod20_tinh_LoiNhuan '2020-01-01', '2020-12-31'

--Mod 21: Thủ tục tính doanh số từng món khoảng thời gian (startDate-endDate)
Create proc Mod21_DoanhSoTungMon
				@NgayBatDau date,
				@NgayKetThuc date,
				@Ma_Mon varchar(50),
				@DoanhSo int output
as
begin
		select @Ma_Mon=MonNuoc.Ma_Mon, @DoanhSo = sum(BanHang_CT.SoLuong)
		from BanHang_CT inner join MonNuoc on BanHang_CT.Ma_Mon=MonNuoc.Ma_Mon
						inner join BanHang on BanHang.Ma_HD_BanHang=BanHang_CT.Ma_HD_BanHang
		where BanHang.NgayThanhToan between @NgayBatDau and @NgayKetThuc
		group by MonNuoc.Ma_Mon
end
-----Test
DECLARE @a INT
EXEC Mod21_DoanhSoTungMon '2024-10-01', '2024-10-10', 'MN0001', @a OUTPUT
SELECT @a AS MN0001

--Test 22 
CREATE PROCEDURE Mod22_TinhDoanhThuMonNuoc (
    @startDate DATE,
    @endDate DATE
)
AS
BEGIN
    SELECT 
        MonNuoc.Ma_Mon,                      
        MonNuoc.Ten_Mon,                     
        SUM(BanHang_CT.SoLuong * MonNuoc.DonGia) AS DoanhThu  
    FROM BanHang
    JOIN BanHang_CT ON BanHang.Ma_HD_BanHang = BanHang_CT.Ma_HD_BanHang  
    JOIN MonNuoc ON BanHang_CT.Ma_Mon = MonNuoc.Ma_Mon  
    WHERE BanHang.NgayThanhToan BETWEEN @startDate AND @endDate  
    GROUP BY MonNuoc.Ma_Mon, MonNuoc.Ten_Mon  
    ORDER BY DoanhThu DESC
END
--------Test
EXEC Mod22_TinhDoanhThuMonNuoc '2024-01-01', '2024-12-31';

--Mod23: Thủ tục đưa ra món có doanh thu cao nhất vào cuối tuần (t7, cn)
CREATE PROCEDURE Mod23_TimMonDoanhThuCaoNhatCuoiTuan
AS
BEGIN
    SELECT TOP 1 MonNuoc.Ten_Mon, 
                SUM(BanHang_CT.SoLuong * MonNuoc.DonGia) AS TongDoanhThu
    FROM BanHang
    JOIN BanHang_CT ON BanHang.Ma_HD_BanHang = BanHang_CT.Ma_HD_BanHang
    JOIN MonNuoc ON BanHang_CT.Ma_Mon = MonNuoc.Ma_Mon
    WHERE DATEPART(WEEKDAY, BanHang.NgayThanhToan) IN (7, 1) -- Thứ 7: 7, Chủ Nhật: 1
    GROUP BY MonNuoc.Ten_Mon
    ORDER BY TongDoanhThu DESC
END
--gọi thủ tục
EXEC Mod23_TimMonDoanhThuCaoNhatCuoiTuan;

--Mod 24: Thủ tục đưa ra hàng được nhập nhiều nhất trong khoảng thời gian (startDate-endDate)
CREATE PROCEDURE Mod24_HangNhapNhieuNhat
    @startDate DATE,
    @endDate DATE
AS
BEGIN
    SELECT TOP 1
        Hang.Ma_H,
        Hang.Ten_H,
        SUM(Nhap_CT.SoLuong) AS TongSoLuong
    FROM Nhap_CT 
    JOIN Hang ON Nhap_CT.Ma_H = Hang.Ma_H
	JOIN Nhap On Nhap.Ma_HD_Nhap=Nhap_CT.Ma_HD_Nhap
    WHERE Nhap.NgayNhap BETWEEN @startDate AND @endDate
    GROUP BY Hang.Ma_H, Hang.Ten_H
    ORDER BY SUM(Nhap_CT.SoLuong) DESC
END

----Test
EXEC Mod24_HangNhapNhieuNhat  '2024-01-01', '2024-12-31';
